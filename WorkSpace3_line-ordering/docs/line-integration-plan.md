# LINE連携機能 設計プラン

## 1. アカウント連携 (ID連携)

**目的**: `bier.jp`の顧客アカウントとLINEユーザーIDを紐付けることで、顧客にパーソナライズされた体験（例: 購入履歴に基づいたオススメ、配送状況の通知）を提供する。

**実装フロー案**: 

1.  **連携の開始**: ボットサーバー（GAS）が、特定のユーザーIDに対してLINE Platformに連携トークンを要求する。
2.  **連携URLの送信**: ボットサーバーは取得した連携トークンを含むURL (`https://line.me/R/nv/accountLink/...`) をユーザーに送信する。
3.  **ユーザー認証**: ユーザーが連携URLをタップすると、`bier.jp`のログインページが表示される。ユーザーは`bier.jp`のIDとパスワードでログインする。
4.  **Nonceの発行**: ログイン成功後、`bier.jp`のサーバーはセキュアな使い捨てトークン（nonce）を生成し、ユーザーIDと紐付けて保存する。
5.  **アカウント連携の実行**: `bier.jp`サーバーは、nonceを付与してLINE Platformの連携エンドポイントにユーザーをリダイレクトする。
6.  **Webhook通知**: LINE PlatformからボットサーバーのWebhookに、連携完了イベントが送信される。このイベントにはユーザーIDとnonceが含まれる。
7.  **連携の完了**: ボットサーバーは受け取ったnonceを元に`bier.jp`のユーザーIDを特定し、LINEのユーザーIDとのマッピングをデータベースに保存する。

**課題**: アカウント連携を必須にするか、任意にするか。`bier.jp`が元々アカウントなしでも購入できるため、連携なしでも商品をカートに追加できるフローは維持する必要がある。

## 2. リッチメニュー

**目的**: ユーザーが主要な機能へ簡単にアクセスできるように、トーク画面下部に常設メニューを設置する。

**メニュー構成案**:

- **エリアA**: 「おすすめを聞く」or「ビールを探す」
  - タイプ: `postback` or `message`
  - アクション: チャットボットに特定のアクションを促すテキストを送信する。
- **エリアB**: 「買い物かご」
  - タイプ: `uri`
  - アクション: `bier.jp`の買い物かごページのURLに遷移させる。
- **エリアC**: 「注文履歴」or「マイページ」
  - タイプ: `uri`
  - アクション: `bier.jp`のマイページURLに遷移させる（要アカウント連携）。
- **エリアD**: 「公式サイトTOP」
  - タイプ: `uri`
  - アクション: `bier.jp`のトップページのURLに遷移させる。

**実装**: LINE Official Account ManagerまたはMessaging API経由で作成・設定する。

## 3. 商品カード (Flex Message)

**目的**: チャットボットが商品を提案する際に、リッチでインタラクティブなメッセージを送信する。

**設計方針**:

- **レイアウト**: 1つの商品を1つの「バブル」で表現する。
- **ヒーローブロック (Hero)**: 商品画像を大きく表示。アスペクト比は`20:13`、フィットモードは`cover`または`fit`を検討。
- **ボディブロック (Body)**:
  - 商品名（太字、大きめのフォント）
  - 販売価格
  - 商品説明（一定文字数で省略し、末尾に「...」を付与する処理を入れる）
- **フッターブロック (Footer)**:
  - **「商品かごに追加」ボタン**: 
    - アクション: `uri`
    - URI: `bier.jp`ドメインに設置した「買い物かご追加API」のURL。商品IDをクエリパラメータとして付与する。
    - 例: `https://bier.jp/api/add-to-cart?itemId=Ex101i`
  - **「詳細はこちら」ボタン**:
    - アクション: `uri`
    - URI: `bier.jp`の該当商品詳細ページのURL。

**課題**: 
- `uri`アクションのURLは`https`で始まる必要がある。APIのURLスキーマに注意。
- Flex MessageのJSON構造が複雑なため、`Flex Message Simulator`を活用してデザインとデバッグを行う。
