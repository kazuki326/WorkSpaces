# 技術仕様書 - ビール画像検索システム

## 概要

本ドキュメントは、ビール画像検索システムの技術仕様について記載します。ユーザーがアップロードしたビールのラベルやボトル画像から、データベース内の一致するビールを検索する機能を提供します。

---

## 画像認識技術

### 使用技術

| 技術 | 説明 |
|------|------|
| **特徴量抽出** | 畳み込みニューラルネットワーク（CNN）を使用して画像から特徴ベクトルを抽出 |
| **類似度計算** | コサイン類似度を使用して特徴ベクトル間の距離を計算 |
| **ラベル認識** | OCR技術を併用してビール名やブランド名を文字認識 |

### 処理パイプライン

1. **前処理**: 画像のリサイズ、正規化、ノイズ除去
2. **特徴抽出**: CNNモデルによる特徴ベクトルの生成
3. **インデックス検索**: ベクトルデータベースでの近傍探索
4. **ランキング**: 類似度スコアに基づく結果のソート
5. **後処理**: 重複除去、信頼度フィルタリング

### モデル仕様

```
入力サイズ: 224 x 224 ピクセル（RGB）
特徴ベクトル次元: 512
対応カラーモード: RGB, RGBA（透過は自動変換）
```

---

## API設計

### エンドポイント

#### 画像検索 API

```
POST /api/v1/image-search
```

**リクエスト**

| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `image` | File | Yes | アップロードする画像ファイル |
| `limit` | Integer | No | 返却する結果の最大数（デフォルト: 10） |
| `threshold` | Float | No | 類似度の最小閾値（0.0〜1.0、デフォルト: 0.5） |

**レスポンス**

```json
{
  "status": "success",
  "results": [
    {
      "beer_id": "12345",
      "name": "サッポロ黒ラベル",
      "brewery": "サッポロビール",
      "similarity": 0.95,
      "image_url": "/images/beers/12345.jpg"
    }
  ],
  "query_time_ms": 120
}
```

#### ステータスコード

| コード | 説明 |
|--------|------|
| 200 | 成功 |
| 400 | 無効なリクエスト（画像形式エラー等） |
| 413 | ファイルサイズ超過 |
| 500 | サーバーエラー |

---

## データフロー

### システムアーキテクチャ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │────▶│  API Server │────▶│  ML Engine  │
│  (Browser)  │     │  (REST API) │     │  (Python)   │
└─────────────┘     └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │  Beer DB    │     │ Vector DB   │
                    │  (MySQL)    │     │  (Pinecone) │
                    └─────────────┘     └─────────────┘
```

### データ処理フロー

1. **クライアント**: ユーザーが画像をアップロード
2. **APIサーバー**: 画像を受信、バリデーション実行
3. **MLエンジン**: 画像から特徴ベクトルを抽出
4. **ベクトルDB**: 類似ベクトルを検索
5. **ビールDB**: ビール情報を取得
6. **クライアント**: 検索結果を表示

### データベース設計

#### beers テーブル

| カラム | 型 | 説明 |
|--------|------|------|
| id | INT | プライマリキー |
| name | VARCHAR(255) | ビール名 |
| brewery | VARCHAR(255) | 醸造所名 |
| style | VARCHAR(100) | ビールスタイル |
| image_url | VARCHAR(500) | ラベル画像URL |
| created_at | TIMESTAMP | 登録日時 |

#### beer_vectors テーブル

| カラム | 型 | 説明 |
|--------|------|------|
| id | INT | プライマリキー |
| beer_id | INT | beersテーブルへの外部キー |
| vector | BLOB | 特徴ベクトル（512次元） |
| updated_at | TIMESTAMP | 更新日時 |

---

## セキュリティ要件

- アップロード画像は一時保存後、処理完了時に削除
- 最大ファイルサイズ: 10MB
- 対応MIMEタイプの厳格なチェック
- レート制限: 1分あたり30リクエスト/IP

---

## パフォーマンス目標

| 指標 | 目標値 |
|------|--------|
| 平均応答時間 | 500ms以下 |
| 99パーセンタイル | 2秒以下 |
| 同時接続数 | 100接続 |
| データベース内ビール数 | 10,000件対応 |

---

## 今後の拡張予定

- バーコード/QRコード読み取り機能
- 複数画像からの統合検索
- ユーザーフィードバックによる学習機能
- オフライン検索モード（PWA対応）
