<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkSpace1: テイスティングノート機能</title>
    <link rel="stylesheet" href="../common_style.css">
    <script src="../workspace-nav.js"></script>
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <header>
        <h1>WorkSpace1: テイスティングノート機能</h1>
        <p>購入者がビールのテイスティング結果を記録し、その平均評価を商品ページに「口コミ」として掲載する機能の企画・設計資料です。</p>
    </header>

    <main>
        <div class="container">
            <h2>機能プレビュー</h2>
            <div class="preview-links">
                <p>Miroボードで検討されたUI/UXのモックアップです。リンクをクリックして各プレビューをポップアップで確認できます。</p>
                <ul>
                    <li><a href="#" onclick="openModal('preview/1_input_form.html', '1. テイスティングノート入力フォーム'); return false;">1. テイスティングノート入力フォーム</a></li>
                    <li><a href="#" onclick="openModal('preview/2_rating_sliders.html', '2. 評価スライダーUI'); return false;">2. 評価スライダーUI</a></li>
                    <li><a href="#" onclick="openModal('preview/3_collection_view.html', '3. Myビール図鑑（コレクション）'); return false;">3. Myビール図鑑（コレクション）</a></li>
                    <li><a href="#" onclick="openModal('preview/4_collection_popup.html', '4. ポップアップ詳細（レーダーチャート付き）'); return false;">4. ポップアップ詳細（レーダーチャート付き）</a></li>
                    <li><a href="#" onclick="openModal('preview/5_barcode_scanner.html', '5. バーコードスキャナー'); return false;">5. バーコードスキャナー</a></li>
                </ul>
            </div>

            <h2>設計ドキュメント</h2>
            <div class="docs-container">
                <details class="doc-toggle" data-doc="docs/feature-specification.md">
                    <summary>機能仕様書</summary>
                    <div class="doc-toggle-content loading">読み込み中...</div>
                </details>

                <details class="doc-toggle" data-doc="docs/technical-plan.md">
                    <summary>技術的実装プラン</summary>
                    <div class="doc-toggle-content loading">読み込み中...</div>
                </details>

                <details class="doc-toggle" data-doc="docs/ideas-and-brainstorming.md">
                    <summary>アイデアとブレインストーミング</summary>
                    <div class="doc-toggle-content loading">読み込み中...</div>
                </details>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 bier.jp WorkSpaces</p>
    </footer>

    <!-- Modal Structure -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="modal-iframe" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // モーダル機能
        // ===================================
        const modalOverlay = document.getElementById('modalOverlay');
        const modalIframe = document.getElementById('modal-iframe');
        const modalTitle = document.getElementById('modalTitle');

        function openModal(url, title) {
            modalIframe.src = url;
            modalTitle.textContent = title;
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            setTimeout(() => {
                if (!modalOverlay.classList.contains('active')) {
                    modalIframe.src = '';
                }
            }, 300);
        }

        modalOverlay.addEventListener('click', function(event) {
            if (event.target === modalOverlay) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modalOverlay.classList.contains('active')) {
                closeModal();
            }
        });

        // ===================================
        // マークダウン読み込み・表示
        // ===================================
        const loadedDocs = new Map();

        async function loadMarkdown(docPath, contentElement) {
            // 既に読み込み済みならキャッシュを使用
            if (loadedDocs.has(docPath)) {
                contentElement.innerHTML = loadedDocs.get(docPath);
                contentElement.classList.remove('loading');
                return;
            }

            try {
                const response = await fetch(docPath);
                if (!response.ok) throw new Error('Failed to load');

                const markdown = await response.text();
                const html = marked.parse(markdown);
                const wrappedHtml = `<div class="markdown-body">${html}</div>`;

                loadedDocs.set(docPath, wrappedHtml);
                contentElement.innerHTML = wrappedHtml;
                contentElement.classList.remove('loading');
            } catch (error) {
                contentElement.innerHTML = `<p style="color: var(--color-danger);">ドキュメントの読み込みに失敗しました。</p>`;
                contentElement.classList.remove('loading');
            }
        }

        // トグル開閉時にマークダウンを読み込む
        document.querySelectorAll('.doc-toggle').forEach(toggle => {
            toggle.addEventListener('toggle', function() {
                if (this.open) {
                    const docPath = this.dataset.doc;
                    const contentElement = this.querySelector('.doc-toggle-content');
                    if (contentElement.classList.contains('loading')) {
                        loadMarkdown(docPath, contentElement);
                    }
                }
            });
        });
    </script>
</body>
</html>
